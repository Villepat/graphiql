<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <script src="https://unpkg.com/frappe-charts@1.2.4/dist/frappe-charts.min.iife.js"></script>


	<title>Welcome to the world of API's</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100vh;
		}

		h1 {
			font-size: 3em;
			text-align: center;
			margin-bottom: 1em;
		}
	</style>
<script>
    // Accessing data from the Go server

var xpTransactionsData = {{.XPTransactionsJSON}};
    var highestAmountsData = {{.HighestAmountsJSON}};
    var userData = {{.UserJSON}};

    // Accessing XPTransactionsJSON
    console.log("XP Transactions: ", xpTransactionsData);

    // Accessing UserJSON
    console.log("User data: ", userData);
  

    document.addEventListener("DOMContentLoaded", function() {
        var data = [];
        for (var key in highestAmountsData) {
            data.push({ skill: key, level: highestAmountsData[key] });
        }

        var svg = document.getElementById("bar-chart");
        var barWidth = 40;
        var barSpacing = 20;
        var chartHeight = parseInt(svg.getAttribute("height"));
        var chartWidth = parseInt(svg.getAttribute("width"));
        var maxBarHeight = chartHeight * 0.8;
        var yAxisLabelSpacing = 20;

        // Calculate the maximum level in the data
        var maxLevel = 100;

        // Scaling factor to fit bars within the range of 0-100
        var scaleY = maxBarHeight / maxLevel;

        // Draw the y-axis labels
        for (var i = 0; i <= 100; i += 20) {
            var yLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yLabel.textContent = i;
            yLabel.setAttribute("x", yAxisLabelSpacing);
            yLabel.setAttribute("y", chartHeight - (i * scaleY) + 4);
            yLabel.setAttribute("font-size", "12px");
            yLabel.setAttribute("text-anchor", "end");
            svg.appendChild(yLabel);
        }

        data.forEach(function (d, i) {
            var bar = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            var barHeight = d.level * scaleY;
            bar.setAttribute("width", barWidth);
            bar.setAttribute("height", barHeight);
            bar.setAttribute("x", yAxisLabelSpacing + 10 + i * (barWidth + barSpacing));
            bar.setAttribute("y", chartHeight - barHeight);
            bar.setAttribute("fill", "rgba(75, 192, 192, 0.8)");
            svg.appendChild(bar);

            var text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            //remove skill_ from the skill name and title case it
            var skillName = d.skill.replace("skill_", "");
            skillName = skillName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            text.textContent = skillName;
            text.setAttribute("x", yAxisLabelSpacing + 10 + i * (barWidth + barSpacing) + barWidth / 2);
            text.setAttribute("y", chartHeight - barHeight - 5);
            text.setAttribute("font-size", "12px");
            text.setAttribute("text-anchor", "middle");
            svg.appendChild(text);
            //when cursor is over the bar, show the level
            bar.addEventListener("mouseover", function() {
                text.textContent = "LVL" + ": " + d.level + "LET'S FUCKING GOOOOO";
                text.setAttribute("fill", "red")
               
            });
            //when cursor is not over the bar, show the skill name
            bar.addEventListener("mouseout", function() {
                text.textContent = skillName;
                text.setAttribute("fill", "black")
            });

        });
    });
    document.addEventListener("DOMContentLoaded", function() {
    // Accessing UserJSON and displaying user's id, login, auditRatio, and campus
    var userElement = document.getElementById("user");

    userElement.innerHTML = `
        <p>User ID: ${userData.id}</p>
        <p>Login: ${userData.login}</p>
        <p>Audit Ratio: ${userData.auditRatio}</p>
        <p>Campus: ${userData.campus}</p>
    `;
});


// Assuming userData is already defined
var transactions = xpTransactionsData;

// Function to convert date string to Date object
function parseDate(dateString) {
    return new Date(dateString);
}

// Extract the earliest and latest dates from the transactions
var minDate = parseDate(transactions[0].createdAt);
var maxDate = parseDate(transactions[transactions.length - 1].createdAt);
console.log(minDate);
console.log(maxDate);

transactions.forEach(function(transaction) {
    var currentDate = parseDate(transaction.createdAt);
    if (currentDate < minDate) {
        minDate = currentDate;
    } else if (currentDate > maxDate) {
        maxDate = currentDate;
    }
});

// Create an array of all the days between minDate and maxDate
var dateArray = [];
var currentDate = new Date(minDate);

while (currentDate <= maxDate) {
    dateArray.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
}

// Calculate the daily XP amounts
var dailyXP = dateArray.map(function(date) {
    var xp = 0;
    transactions.forEach(function(transaction) {
        var transactionDate = parseDate(transaction.createdAt);
        if (transactionDate.toDateString() === date.toDateString()) {
            xp += transaction.amount;
        }
    });
    return xp;
});


document.addEventListener("DOMContentLoaded", function() {
    var chart = new frappe.Chart("#plot-chart", {
        title: "Daily XP",
        data: {
            labels: dateArray.map(date => date.toISOString().slice(0, 10)),
            datasets: [
                {
                    name: "XP",
                    values: dailyXP,
                    chartType: 'line'
                }
            ]
        },
        type: 'line',
        height: 250,
        lineOptions: {
            dotSize: 4
        },
        axisOptions: {
            xIsSeries: true
        }
    });
});

</script>

</head>
<body>

        <h1>Let's have a look at what you have been up to üòè</h1>
        <div id="user"></div>
        <svg id="bar-chart" width=80% height=100%></svg>
        <div id="plot-chart"></div>
   
</body>
</html>
